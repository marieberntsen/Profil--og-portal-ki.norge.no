---
import Layout from '../../components/layout/Layout.astro';
import { Heading, Paragraph, Link } from '@digdir/designsystemet-react';
import { getVeiledninger, type Veiledning } from '../../lib/strapi';

// Fetch veiledninger from Strapi
let veiledninger: Veiledning[] = [];
try {
  const veiledningerRes = await getVeiledninger();
  veiledninger = veiledningerRes.data || [];
} catch (error) {
  console.error('Failed to fetch veiledninger:', error);
}

// Group veiledninger by kategori
const groupedVeiledninger = veiledninger.reduce((acc, veiledning) => {
  const kategoriNavn = veiledning.kategori?.navn || 'Annet';
  if (!acc[kategoriNavn]) {
    acc[kategoriNavn] = [];
  }
  acc[kategoriNavn].push(veiledning);
  return acc;
}, {} as Record<string, Veiledning[]>);

// Convert to array format for rendering
const categories = Object.entries(groupedVeiledninger).map(([title, items]) => ({
  title,
  items: items.map(v => ({
    title: v.tittel,
    description: v.innhold?.[0]?.children?.[0]?.text?.substring(0, 80) || '',
    href: `/veiledning/${v.slug}`,
  })),
}));

const hasContent = categories.length > 0;
---

<Layout title="Veiledning" description="Veiledningsressurser for ansvarlig bruk av kunstig intelligens i offentlig sektor.">
  <div class="page-container">
    <header class="page-header">
      <Heading level={1} size="2xlarge">Veiledning</Heading>
    </header>

    {hasContent ? (
      <div class="categories">
        {categories.map((category) => (
          <section class="category">
            <Heading level={2} size="large" class="category-title">{category.title}</Heading>
            <div class="items-grid">
              {category.items.map((item) => (
                <Link href={item.href} class="item-card">
                  <Heading level={3} size="small" class="item-title">{item.title}</Heading>
                  <Paragraph size="small" class="item-description">{item.description}</Paragraph>
                </Link>
              ))}
            </div>
          </section>
        ))}
      </div>
    ) : (
      <div class="empty-state">
        <Paragraph>Ingen veiledninger er publisert ennå.</Paragraph>
        <Link href="/">Gå til forsiden</Link>
      </div>
    )}
  </div>
</Layout>

<style>
  .page-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: var(--ds-size-8) var(--ds-size-4);
  }

  .page-header {
    margin-bottom: var(--ds-size-8);
  }

  .page-header :global(h1) {
    margin: 0 0 var(--ds-size-4);
  }

  .lead {
    margin: 0;
  }

  .categories {
    display: flex;
    flex-direction: column;
    gap: var(--ds-size-8);
    margin-bottom: var(--ds-size-10);
  }

  .category-title {
    margin: 0 0 var(--ds-size-4);
    padding-bottom: var(--ds-size-2);
    border-bottom: 2px solid var(--ds-color-accent-border-default);
  }

  .items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--ds-size-4);
  }

  .item-card {
    display: block;
    padding: var(--ds-size-5);
    background-color: var(--ds-color-neutral-surface-default);
    border: 1px solid var(--ds-color-neutral-border-subtle);
    border-radius: var(--ds-border-radius-md);
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
  }

  .item-card:hover {
    border-color: var(--ds-color-accent-border-default);
    box-shadow: var(--ds-shadow-sm);
  }

  .item-title {
    margin: 0 0 var(--ds-size-2);
    color: var(--ds-color-accent-text-default);
  }

  .item-description {
    margin: 0;
  }

  .cta-section {
    padding: var(--ds-size-8);
    background-color: var(--ds-color-accent-surface-default);
    border-radius: var(--ds-border-radius-lg);
    text-align: center;
  }

  .cta-section :global(h2) {
    margin: 0 0 var(--ds-size-2);
  }

  .cta-section :global(p) {
    margin: 0 0 var(--ds-size-4);
  }

  .empty-state {
    text-align: center;
    padding: var(--ds-size-12) var(--ds-size-4);
  }

  .empty-state :global(p) {
    margin: 0 0 var(--ds-size-4);
    color: var(--ds-color-neutral-text-subtle);
  }
</style>
